<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>JellyStore</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
    <h1>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h1>
    <div id="status">–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
    
    <script>
    // 1. –ù–ê–°–¢–†–û–ô–ö–ò TELEGRAM (—Å–∞–º–æ–µ –ø–µ—Ä–≤–æ–µ!)
    Telegram.WebApp.options.skip_ssl_validation = true;
    Telegram.WebApp.options.use_cloud_storage = false;

    const API_BASE_URL = 'http://192.168.1.153:5000';
    let isRequestSent = false; // ‚Üê –§–ª–∞–≥ –ø—Ä–æ—Ç–∏–≤ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫

    // 2. –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö
    async function sendInitDataToBackend() {
        if (isRequestSent) {
            console.log('–ó–∞–ø—Ä–æ—Å —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º');
            return;
        }
        isRequestSent = true;
        
        try {
            const statusElement = document.getElementById('status');
            statusElement.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä...';
            
            console.log('üîÑ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º initData:', Telegram.WebApp.initData ? '–µ—Å—Ç—å' : '–Ω–µ—Ç');
            
            const response = await fetch(`${API_BASE_URL}/api/data`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    initData: Telegram.WebApp.initData
                })
            });
            
            console.log('üì® –û—Ç–≤–µ—Ç –ø–æ–ª—É—á–µ–Ω. –°—Ç–∞—Ç—É—Å:', response.status);
            
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`HTTP ${response.status}: ${errorText}`);
            }
            
            const result = await response.json();
            
            if (result.status === 'success') {
                statusElement.textContent = '‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!';
                statusElement.style.color = 'green';
                
                Telegram.WebApp.expand();
                Telegram.WebApp.enableClosingConfirmation();
                
            } else {
                throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
            }
            
        } catch (error) {
            console.error('‚ùå –û—à–∏–±–∫–∞:', error);
            const statusElement = document.getElementById('status');
            statusElement.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + error.message;
            statusElement.style.color = 'red';
            
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–∏
            isRequestSent = false;
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –ø–æ–≤—Ç–æ—Ä–∞ –µ—Å–ª–∏ –µ—â–µ –Ω–µ—Ç
            if (!document.getElementById('retry-btn')) {
                const retryButton = document.createElement('button');
                retryButton.id = 'retry-btn';
                retryButton.textContent = '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É';
                retryButton.onclick = sendInitDataToBackend;
                document.body.appendChild(retryButton);
            }
        }
    }

    // 3. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø TELEGRAM WEBAPP
    Telegram.WebApp.ready();
    
    // –ñ–¥–µ–º –∫–æ–≥–¥–∞ Telegram WebApp –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è
    Telegram.WebApp.onEvent('viewportChanged', function() {
        console.log('Telegram WebApp –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ initData
        if (!Telegram.WebApp.initData) {
            console.warn('‚ö†Ô∏è InitData –Ω–µ –ø–æ–ª—É—á–µ–Ω–∞ –æ—Ç Telegram');
            document.getElementById('status').textContent = '‚ùå –û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ—Ç Telegram...';
            return;
        }
        
        console.log('‚úÖ InitData –ø–æ–ª—É—á–µ–Ω–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å...');
        setTimeout(sendInitDataToBackend, 500); // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
    });

    // 4. –ó–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç –Ω–∞ —Å–ª—É—á–∞–π –µ—Å–ª–∏ onEvent –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–µ—Ç
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM –∑–∞–≥—Ä—É–∂–µ–Ω');
        
        // –î–∞–µ–º Telegram –≤—Ä–µ–º—è –Ω–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
        setTimeout(function() {
            if (Telegram.WebApp.initData) {
                sendInitDataToBackend();
            } else {
                console.warn('InitData –≤—Å–µ –µ—â–µ –Ω–µ –≥–æ—Ç–æ–≤–∞');
            }
        }, 1000);
    });

</script>
</body>
</html>






