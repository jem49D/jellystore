<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>JellyStore</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    
</head>
<body>
    <h1>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö</h1>
    <div id="status">–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>

        <h1 style="text-align: center;">–ö–∞—Ç–∞–ª–æ–≥ —Ç–æ–≤–∞—Ä–æ–≤</h1>
    
    <div class="search-form">
        <input type="text" id="search-input" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤...">
        <select id="category-select">
            <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
            <option value="electronics">–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞</option>
            <option value="clothing">–û–¥–µ–∂–¥–∞</option>
            <option value="books">–ö–Ω–∏–≥–∏</option>
        </select>
        <button onclick="searchProducts()">–ü–æ–∏—Å–∫</button>
    </div>
    
    <div id="product-grid" class="product-grid">
        <!-- –¢–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –∑–¥–µ—Å—å —á–µ—Ä–µ–∑ JavaScript -->
    </div>
    
    <div id="loading" class="loading hidden">
        ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤...
    </div>
    
    <div id="no-more" class="loading hidden">
        ‚úÖ –¢–æ–≤–∞—Ä—ã –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å!
    </div>

    <!-- <script src="{{ url_for('static', filename='js/infinite-scroll.js') }}"></script> -->
    
    <script>
        const API_BASE_URL = 'http://localhost:5000';

        // –ñ–¥–µ–º –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ Telegram Web App
        Telegram.WebApp.ready();
        
        // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ—Ç Telegram
        const tg = window.Telegram.WebApp;
        const initData = tg.initData;
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –±—ç–∫–µ–Ω–¥
        async function sendInitDataToBackend() {
            try {
                const statusElement = document.getElementById('status');
                statusElement.textContent = '–û—Ç–ø—Ä–∞–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä...';
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º POST-–∑–∞–ø—Ä–æ—Å —Å JSON –¥–∞–Ω–Ω—ã–º–∏
                const response = await fetch(`${API_BASE_URL}/api/data`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: initData
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status}`);
                }
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    statusElement.textContent = '‚úÖ –î–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã!';
                    statusElement.style.color = 'green';
                    
                    // –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–∞–ª—å—à–µ
                    tg.expand(); // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º Mini App –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
                    tg.enableClosingConfirmation(); // –í–∫–ª—é—á–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è
                    
                } else {
                    throw new Error(result.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
                }
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                const statusElement = document.getElementById('status');
                statusElement.textContent = '‚ùå –û—à–∏–±–∫–∞: ' + error.message;
                statusElement.style.color = 'red';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–æ–≤—Ç–æ—Ä–∞
                const retryButton = document.createElement('button');
                retryButton.textContent = '–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É';
                retryButton.onclick = sendInitDataToBackend;
                document.body.appendChild(retryButton);
            }
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', function() {
            if (!initData) {
                document.getElementById('status').textContent = '‚ùå –û—à–∏–±–∫–∞: –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç Telegram';
                return;
            }
            
            sendInitDataToBackend();
        });


let currentPage = 1;
let isLoading = false;
let hasMore = true;
let currentSearch = '';
let currentCategory = '';

function loadProducts(reset = false) {
    // 1. –ó–∞—â–∏—Ç–∞ –æ—Ç –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
    if (isLoading || !hasMore) return;
    
    // 2. –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏
    if (reset) {
        currentPage = 1;
        hasMore = true;
        document.getElementById('product-grid').innerHTML = '';
        document.getElementById('no-more').classList.add('hidden');
    }
    
    // 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
    isLoading = true;
    document.getElementById('loading').classList.remove('hidden');
    
    // 4. –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ URL –∑–∞–ø—Ä–æ—Å–∞
    let url = `${API_BASE_URL}/api/products?page=${currentPage}`;
    // if (currentSearch || currentCategory) {
    //     url = `/api/products/search?page=${currentPage}`;
    //     if (currentSearch) url += `&q=${encodeURIComponent(currentSearch)}`;
    //     if (currentCategory) url += `&category=${encodeURIComponent(currentCategory)}`;
    // } –ø–æ–∏—Å–∫ –ø–æ–∫–∞ —á—Ç–æ –Ω–µ –∞–∫—Ç—É–∞–ª–µ–Ω

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                        if (data.success) {
            console.log('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –æ—Ç–≤–µ—Ç, —Ç–æ–≤–∞—Ä–æ–≤:', data.products.length);
            console.log('üìä has_more:', data.has_more);
            console.log('üî¢ –¢–æ–≤–∞—Ä—ã:', data.products);}
                const productGrid = document.getElementById('product-grid');
                
                data.products.forEach(product => {
                    const productCard = createProductCard(product);
                    productGrid.appendChild(productCard);
                });
                
                hasMore = data.has_more;
                currentPage++;
                
                if (!hasMore && data.products.length > 0) {
                    document.getElementById('no-more').classList.remove('hidden');
                }
            } else {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', data.error);
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
        })
        .finally(() => {
            isLoading = false;
            document.getElementById('loading').classList.add('hidden');
        });
}

function createProductCard(product) {
    const card = document.createElement('div');
    card.className = 'product-card';
    
    card.innerHTML = `
        ${product.image_url ? 
            `<img src="${product.image_url}" alt="${product.name}" class="product-image">` : 
            '<div style="height: 200px; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">üì∑ –ù–µ—Ç –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>'
        }
        <h3>${product.name_tov}</h3>
        <p>${product.description ? product.description.substring(0, 100) + '...' : '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}</p>
        <p><strong>–¶–µ–Ω–∞: ${product.price ? product.price + ' —Ä—É–±.' : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</strong></p>
    `;
    
    return card;
}
//  ${product.category ? `<p>–ö–∞—Ç–µ–≥–æ—Ä–∏—è: ${product.category}</p>` : ''} –≤—ã—à–µ –ø—Ä–∏–≥–æ–¥–∏—Ç—Å—è –º–±
// function searchProducts() {
//     currentSearch = document.getElementById('search-input').value;
//     currentCategory = document.getElementById('category-select').value;
//     loadProducts(true);
// } –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ –Ω—É–∂–Ω–æ

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ–∫—Ä—É—Ç–∫–∏
window.addEventListener('scroll', () => {
    const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
    
    if (scrollTop + clientHeight >= scrollHeight - 100) {
        loadProducts();
    }
});

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ Enter –≤ –ø–æ–ª–µ –ø–æ–∏—Å–∫–∞
// document.getElementById('search-input').addEventListener('keypress', (e) => {
//     if (e.key === 'Enter') {
//         searchProducts();
//     }
// }); –≤—Ä–µ–º–µ–Ω–æ –Ω–µ –Ω—É–∂–Ω–æ

// –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–≤—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
document.addEventListener('DOMContentLoaded', () => loadProducts(true));

    </script>
</body>
</html>



