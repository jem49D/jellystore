<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
    <link rel="stylesheet" href="style.css">
    <title>JellyStore</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>

html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    -ms-overflow-style: none;
    scrollbar-width: none;
    background: #f9f9f9;
}

.bottom-nav {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: white;
    display: flex;
    justify-content: space-around;
    align-items: center;
    padding: 4px 0;
    border-top: 1px solid #e0e0e0;
    box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
    z-index: 1000;
}

.nav-item {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 2px 4px;
    border: none;
    background: none;
    cursor: pointer;
    opacity: 0.6;
    transition: all 0.3s ease;
    flex: 1;
    text-align: center;
}

.nav-item.active {
    opacity: 1;
    color: #E491A6;
}

.nav-icon {
    width: 28px; /* Фиксированный размер для всех картинок */
    height: 28px;
    object-fit: contain; /* Сохраняет пропорции, не обрезает */
    margin-bottom: 2px;
    margin-top: 8px;
    opacity: 0.6;
    transition: all 0.3s ease;
}

.nav-item.active .nav-icon {
    opacity: 1;
    filter: brightness(0) saturate(100%) invert(67%) sepia(12%) saturate(1233%) hue-rotate(295deg) brightness(95%) contrast(85%);
}

@media (max-width: 768px) {
    .bottom-nav {
        padding: 3px 0;
    }
    
    .nav-icon {
        width: 24px;
        height: 24px;
    }
    
}

.product-card {
    border: 1px solid #ddd;
    border-radius: 16px;
    padding: 15px;
    background: white;
    text-align: left;
    width: 100%;
    box-sizing: border-box;
}

.product-card img {
    width: 100%;
    height: 140px;
    object-fit: cover;
    border-radius: 16px;
}

.product-card h2 {
    margin: 10px 0px 8px 0px;
    font-weight: 600;
    font-size: 16px;
}

.opis {
    color: #666;
    font-size: 14px;
    line-height: 1.4;
    margin: 0 0 25px 0;
    
}

.price-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    font-size: 14px;
}

.buy-button {
    width: 32px;
    height: 32px;
    background: #E491A6;
    border: none;
    border-radius: 8px;
    color: #fff;
    font-size: 25px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
}

.buy-button:hover {
    background: #D48297;
}

.buy-button:active {
    background: #C57388;
    transform: scale(0.95);
}

.two-card-container {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 20px;
    width: 100%;
    max-width: 375px;
}

.product-grid {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 20px;
    padding: 20px;
}

body {
    background: #f9f9f9;
    margin: 0;
    padding: 0;
}

.banner {
    background-color: #845673;
    color: white;
    width: 100%;
    height: 280px;
    margin: 0;
}

.bannercen {
    width: 375px;
    height: 280px;
    margin: 0 auto; 
    display: block; 
}
 
.banner h1 {
    margin: 0px 0;
    font-size: 26px;
}

.banner p {
    margin: 0;
    font-size: 12px;
    color: #A2A2A2;
}

.banner button {
    color: white;
    background: #E491A6;
    border: none;
    padding: 5px 10px;
    border-radius: 20px;
    font-weight: bold;
    font-size: 14px;
    cursor: pointer;
    margin-top: 20px;
     border-radius: 5px;
}

.banner button:hover {
    background-color: #D48297; 
    transform: translateY(-2px); 
    cursor: pointer;
}

.banner button:active {
    background-color: #C57388;
    transform: translateY(0); /* Возвращаем на место */
}

.search-form {
    display: none;
}


.loading {
    text-align: center;
    padding: 20px;
    font-size: 16px;
}

.hidden {
    display: none;
}

html {
    -webkit-overflow-scrolling: touch;
}

button, .product-card {
    -webkit-tap-highlight-color: transparent;
}

.infban{
    padding: 60px 20px;
}

.poisk{
  display: flex;
    align-items: center;
    justify-content: center; 
    width: 100%;
    margin-top: 20px;
    gap: 10px;
}

.poisk button{
    width: 52px;
    height: 52px;
    background-color: #E491A6; 
    background-image: url('poisk.png'); 
    background-repeat: no-repeat;
    background-position: center;
    background-size: 24px 24px; 
    border: none;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.poisk button:hover {
    background-color: #D48297; 
    transform: translateY(-2px); 
    box-shadow: 0 4px 12px rgba(228, 145, 166, 0.3); 
    cursor: pointer;
}

.poisk button:active {
    background-color: #C57388;
    transform: translateY(0); 
}

.poisk input{
background-color: #845673;
height: 52px;
width: 260px;
border: none;
border-radius: 12px;
color: #fff;
padding: 0 15px;
}

.poisk input::placeholder {
    color: #ffffff;
    opacity: 0.8; 
}

.poisk input:focus {
    outline: 2px solid #E491A6;
}

.cater {
    padding: 15px 20px;
    margin-top: 20px;
}

.categories-container {
    position: relative;
    width: 100%;
    max-width: 375px;
    margin: 0 auto;
}

.categories-scroll {
    display: flex;
    gap: 10px;
    overflow-x: auto; /* ВКЛЮЧАЕТ ГОРИЗОНТАЛЬНУЮ ПРОКРУТКУ */
    scroll-behavior: smooth;
    padding: 10px 5px; /* ДОБАВЬТЕ БОКОВЫЕ ОТСТУПЫ */
    -webkit-overflow-scrolling: touch;
    scrollbar-width: none;
    cursor: grab;
        /* ДОБАВЬТЕ ЭТИ СТРОКИ */
    width: 100%;
    min-width: 0;
}

.categories-scroll:active {
    cursor: grabbing;
}

.categories-scroll::-webkit-scrollbar {
    display: none;
}

.category-btn {
    flex: 0 0 auto; /* ВАЖНО: не дает кнопкам сжиматься */
    padding: 10px 20px;
    background: #845673;
    color: white;
    border: none;
    border-radius: 20px;
    font-size: 14px;
    cursor: pointer;
    white-space: nowrap;
    transition: all 0.3s ease;
    
    /* Для iOS */
    -webkit-user-select: none;
    user-select: none;
}

.category-btn:hover {
    background: #734562;
    transform: translateY(-2px);
}

.category-btn.active {
    background: #E491A6;
    font-weight: 600;
}

/* УДАЛИТЕ ВЕСЬ ЭТОТ БЛОК */
/*
.scroll-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    width: 32px;
    height: 32px;
    background: #E491A6;
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 18px;
    cursor: pointer;
    z-index: 10;
    display: none;
}

.scroll-left {
    left: -15px;
}

.scroll-right {
    right: -15px;
}

.categories-container:hover .scroll-btn {
    display: block;
}
*/

@media (max-width: 480px) {
    .cater {
        padding: 10px 15px;
    }
    
    .category-btn {
        padding: 8px 16px;
        font-size: 13px;
    }
    
    /* УДАЛИТЕ ЭТИ СТИЛИ */
    /*
    .scroll-btn {
        width: 28px;
        height: 28px;
        font-size: 16px;
    }
    
    .scroll-left {
        left: -10px;
    }
    
    .scroll-right {
        right: -10px;
    }
    */

}

</style>
</head>
<body>

    <div class="banner">
        <div class="bannercen">
        <div class="infban">
            <p>Твой магазин закусок</p>
            <h1>JellyStore</h1>
            <button>Подробнее</button>
        </div>
        </div>
    </div>

    <div class="poisk">
        <input type="text" placeholder="Поиск">
        <button></button>
    </div>

    <div class="cater">
    <div class="categories-container">
        <div class="categories-scroll" id="categoriesScroll">

        </div>
    </div>
    </div>

    <div id="status">Отправка данных...</div>
    
    <div id="product-grid" class="product-grid">

    </div>
    
    <div id="loading" class="loading hidden">⏳ Загрузка товаров...</div>
    
    <div id="no-more" class="loading hidden">✅ Товары закончились!</div>

<nav class="bottom-nav">
    <div class="nav-item active">
        <img src="icon/home.png" alt="Главная" class="nav-icon">
    </div>
    <div class="nav-item">
        <img src="icon/kat.png" alt="Корзина" class="nav-icon">
    </div>
    <div class="nav-item">
        <img src="icon/prof.png" alt="Профиль" class="nav-icon">
    </div>
</nav>
    
   <script>

    const API_BASE_URL = 'http://localhost:5000';

    Telegram.WebApp.ready();
    
    const tg = window.Telegram.WebApp;
    const initData = tg.initData;
    
    async function sendInitDataToBackend() {
        try {
            const statusElement = document.getElementById('status');
            statusElement.textContent = 'Отправка данных на сервер...';
            
            const response = await fetch(`${API_BASE_URL}/api/data`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    initData: initData
                })
            });
            
            if (!response.ok) {
                throw new Error(`Ошибка сервера: ${response.status}`);
            }
            
            const result = await response.json();
            
            if (result.status === 'success') {
                statusElement.textContent = '✅ Данные успешно отправлены и сохранены!';
                statusElement.style.color = 'green';
                
                tg.expand();
                tg.enableClosingConfirmation();
                
            } else {
                throw new Error(result.error || 'Неизвестная ошибка');
            }
            
        } catch (error) {
            console.error('Ошибка:', error);
            const statusElement = document.getElementById('status');
            statusElement.textContent = '❌ Ошибка: ' + error.message;
            statusElement.style.color = 'red';
            
            const retryButton = document.createElement('button');
            retryButton.textContent = 'Повторить попытку';
            retryButton.onclick = sendInitDataToBackend;
            document.body.appendChild(retryButton);
        }
    }
    
    // Запускаем при загрузке страницы
    document.addEventListener('DOMContentLoaded', function() {
        if (!initData) {
            document.getElementById('status').textContent = '❌ Ошибка: Нет данных от Telegram';
            return;
        }
        
        sendInitDataToBackend();
    });

    // Переменные для пагинации
    let currentPage = 1;
    let isLoading = false;
    let hasMore = true;
    // let currentSearch = '';
    // let currentCategory = ''; для поиска  пока не нужно

    // Функция загрузки товаров (ТА, КОТОРУЮ ВЫ ПОКАЗАЛИ)
    function loadProducts(reset = false) {
    if (isLoading || !hasMore) return;
    
    if (reset) {
        currentPage = 1;
        hasMore = true;
        document.getElementById('product-grid').innerHTML = '';
        document.getElementById('no-more').classList.add('hidden');
    }
    
    isLoading = true;
    document.getElementById('loading').classList.remove('hidden');
    
    let url = `${API_BASE_URL}/api/products?page=${currentPage}`;
    
    // Добавляем параметры фильтрации
    // if (currentCategory) {
    //     url += `&category=${currentCategory}`;
    // }
    // if (currentSearch) {
    //     url += `&search=${encodeURIComponent(currentSearch)}`;
    // }
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const productGrid = document.getElementById('product-grid');
                
                if (reset && data.products.length === 0) {
                    productGrid.innerHTML = '<p style="text-align: center; width: 100%;">Товары не найдены</p>';
                    return;
                }
                
                // Группируем товары по 2 штуки и создаем контейнеры
                for (let i = 0; i < data.products.length; i += 2) {
                    const twoProducts = data.products.slice(i, i + 2);
                    const container = createTwoCardContainer(twoProducts);
                    productGrid.appendChild(container);
                }
                
                hasMore = data.has_more;
                currentPage++;
                
                if (!hasMore && data.products.length > 0) {
                    document.getElementById('no-more').classList.remove('hidden');
                }
            } else {
                console.error('Ошибка загрузки:', data.error);
            }
        })
        .catch(error => {
            console.error('Ошибка:', error);
        })
        .finally(() => {
            isLoading = false;
            document.getElementById('loading').classList.add('hidden');
        });
}


    function loadCategories() {
    fetch(`${API_BASE_URL}/api/categories`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                createCategoryButtons(data.kater);
            } else {
                console.error('Ошибка загрузки категорий:', data.error);
                // Создаем тестовые категории если API не работает
                createTestCategories();
            }
        })
        .catch(error => {
            console.error('Ошибка загрузки категорий:', error);
            createTestCategories();
        });
}

    // Функция создания карточки товара
    function createProductCard(product) {
        const card = document.createElement('div');
        card.className = 'product-card';
        
        card.innerHTML = `
            ${product.image_url ? 
                `<img src="${product.image_url}" alt="${product.name_tov}" class="product-image">` : 
                '<div style="height: 200px; background: #f0f0f0; display: flex; align-items: center; justify-content: center;">📷 Нет изображения</div>'
            }
            <h2>${product.name_tov}</h2>
            <p class='opis'>${product.discript_tov ? product.discript_tov.substring(0, 50) + '...' : 'Нет описания'}</p>
            <div class="price-container"><strong>Цена:<br> ${product.price ? product.price + ' руб.' : 'Не указана'}</strong>  
                <button class="buy-button" onclick="addToCart(${product.id})">+</button>
            </div>
        `;
        
        return card;
    }

function createCategoryButtons(categories) {
    const container = document.getElementById('categoriesScroll');
    
    // Очищаем контейнер
    container.innerHTML = '';
    
    // Создаем кнопку "Все"
    const allButton = document.createElement('button');
    allButton.className = 'category-btn active';
    allButton.textContent = 'Все';
    allButton.onclick = () => filterProductsByCategory('');
    container.appendChild(allButton);
    
    // Создаем кнопки категорий
    categories.forEach(category => {
        const button = document.createElement('button');
        button.className = 'category-btn';
        button.textContent = category.name || category.title || 'Категория';
        button.onclick = () => filterProductsByCategory(category.id);
        container.appendChild(button);
    });
}

    // Функция создания контейнера с двумя карточками
    function createTwoCardContainer(products) {
        const container = document.createElement('div');
        container.className = 'two-card-container';
        
        const firstProduct = products[0];
        const secondProduct = products[1];
        
        if (firstProduct) {
            const card1 = createProductCard(firstProduct);
            container.appendChild(card1);
        }
        
        if (secondProduct) {
            const card2 = createProductCard(secondProduct);
            container.appendChild(card2);
        }
        
        return container;
    }

    // Функция добавления в корзину (НУЖНО ДОБАВИТЬ!)
    // function addToCart(productId) {
    //     // Реализация добавления в корзину
    //     console.log('Добавляем товар в корзину:', productId);
        
    //     // Пример реализации:
    //     const button = event.target;
    //     button.style.background = '#4CAF50';
    //     button.textContent = '✓';
        
    //     setTimeout(() => {
    //         button.style.background = '#E491A6';
    //         button.textContent = '+';
    //     }, 1000);
    // }

    // Обработчик прокрутки
    window.addEventListener('scroll', () => {
        const { scrollTop, scrollHeight, clientHeight } = document.documentElement;
        
        if (scrollTop + clientHeight >= scrollHeight - 100) {
            loadProducts();
        }
    });

    // Загрузка первых товаров при загрузке страницы
    document.addEventListener('DOMContentLoaded', () => {
    loadProducts(true);
    loadCategories();
});


function filterProductsByCategory(categoryId) {
    // Убираем активный класс у всех кнопок
    document.querySelectorAll('.category-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Добавляем активный класс к текущей кнопке
    event.target.classList.add('active');
    
    currentCategory = categoryId;
    currentSearch = '';
    
    // Перезагружаем товары с фильтром
    loadProducts(true);
}

function createTestCategories() {
    const testCategories = [
        { id: 1, name: 'Сладости' },
        { id: 2, name: 'Напитки' },
        { id: 3, name: 'Чипсы' },
        { id: 4, name: 'Печенье' },
        { id: 5, name: 'Шоколад' }
    ];
    
    createCategoryButtons(testCategories);
}

document.addEventListener('DOMContentLoaded', function() {
    const navItems = document.querySelectorAll('.nav-item');
    
    navItems.forEach(item => {
        item.addEventListener('click', function() {
            // Убираем активный класс у всех элементов
            navItems.forEach(navItem => {
                navItem.classList.remove('active');
            });
            
            // Добавляем активный класс к нажатому элементу
            this.classList.add('active');
            
            // Можно добавить логику переключения контента
            const tabName = this.getAttribute('data-tab');
            switchTab(tabName);
        });
    });
});

// Добавьте этот код в ваш существующий JavaScript
function initHorizontalScroll() {
    const scrollContainer = document.getElementById('categoriesScroll');
    
    if (!scrollContainer) return;
    
    // Обработчик колесика мыши для горизонтального скролла
    scrollContainer.addEventListener('wheel', (event) => {
        event.preventDefault();
        scrollContainer.scrollLeft += event.deltaY;
    });
}

// Вызовите функцию после загрузки категорий
document.addEventListener('DOMContentLoaded', () => {
    loadProducts(true);
    loadCategories();
    initHorizontalScroll(); // Добавьте эту строку
});

// Функция для перетаскивания мышкой
function initDragScroll() {
    const scrollContainer = document.getElementById('categoriesScroll');
    
    if (!scrollContainer) return;
    
    let isDragging = false;
    let startX;
    let scrollLeft;
    
    // Начало перетаскивания
    scrollContainer.addEventListener('mousedown', (e) => {
        isDragging = true;
        startX = e.pageX - scrollContainer.offsetLeft;
        scrollLeft = scrollContainer.scrollLeft;
        scrollContainer.style.cursor = 'grabbing';
        scrollContainer.style.userSelect = 'none';
    });
    
    // Завершение перетаскивания
    scrollContainer.addEventListener('mouseleave', () => {
        if (isDragging) {
            isDragging = false;
            scrollContainer.style.cursor = 'grab';
            scrollContainer.style.userSelect = 'auto';
        }
    });
    
    scrollContainer.addEventListener('mouseup', () => {
        if (isDragging) {
            isDragging = false;
            scrollContainer.style.cursor = 'grab';
            scrollContainer.style.userSelect = 'auto';
        }
    });
    
    // Перетаскивание
    scrollContainer.addEventListener('mousemove', (e) => {
        if (!isDragging) return;
        e.preventDefault();
        const x = e.pageX - scrollContainer.offsetLeft;
        const walk = (x - startX) * 2; // Скорость прокрутки
        scrollContainer.scrollLeft = scrollLeft - walk;
    });
}

// Вызовите функцию после загрузки DOM
document.addEventListener('DOMContentLoaded', () => {
    loadProducts(true);
    loadCategories();
    initDragScroll(); // Добавьте эту строку
});

</script>
</body>
</html>
